version: '3.8'

services:
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: codingbuddy-api
    restart: always
    environment:
      DATABASE_URL: postgresql://postgres:password@postgres:5432/codingbuddy?schema=public
      REDIS_URL: redis://redis:6379
      USE_MOCK_QUEUE: "false"
      # In full-Docker mode reach Judge0 via container name
      JUDGE0_URL: http://judge0-server:2358
    depends_on:
      - postgres
      - redis
      - judge0-server
    ports:
      - "5000:5000"
    volumes:
      - ./backend:/app
      - /app/node_modules

  worker:
    build:
      context: ./backend
      dockerfile: Dockerfile.worker
    container_name: codingbuddy-worker
    restart: always
    environment:
      DATABASE_URL: postgresql://postgres:password@postgres:5432/codingbuddy?schema=public
      REDIS_URL: redis://redis:6379
      USE_MOCK_QUEUE: "false"
      # In full-Docker mode reach Judge0 via container name
      JUDGE0_URL: http://judge0-server:2358
    depends_on:
      - postgres
      - redis
      - judge0-server

  postgres:
    image: postgres:15-alpine
    container_name: codingbuddy-postgres
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: codingbuddy
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    container_name: codingbuddy-redis
    restart: always
    ports:
      - "6379:6379"

  judge0-server:
    image: judge0/judge0:1.13.1
    command: [ "./scripts/server" ]
    ports:
      - "2358:2358"
    privileged: true
    restart: always
    env_file: judge0.conf
    depends_on:
      - judge0-postgres
      - judge0-redis

  judge0-worker:
    image: judge0/judge0:1.13.1
    command: [ "./scripts/workers" ]
    privileged: true
    restart: always
    env_file: judge0.conf
    depends_on:
      - judge0-postgres
      - judge0-redis

  judge0-postgres:
    image: postgres:15.6
    ports:
      - "5434:5432"
    env_file: judge0.conf
    volumes:
      - judge0_postgres_data:/var/lib/postgresql/data/
    restart: always

  judge0-redis:
    image: redis:7.2.4
    command: [ "bash", "-c", 'docker-entrypoint.sh --appendonly yes --requirepass "$$REDIS_PASSWORD"' ]
    env_file: judge0.conf
    volumes:
      - judge0_redis_data:/data
    restart: always

volumes:
  postgres_data:
  judge0_postgres_data:
  judge0_redis_data:
