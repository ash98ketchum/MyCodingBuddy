// Refactored for SQLite compatibility

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id                String              @id @default(cuid())
  username          String              @unique
  email             String              @unique
  password          String
  fullName          String?
  role              String              @default("USER") // enum Role
  planType          String              @default("FREE") // enum PlanType
  rating            Int?
  streak            Int?
  lastSolvedAt      DateTime?
  avatar            String?
  bio               String?
  country           String?
  organization      String?
  githubUrl         String?
  linkedinUrl       String?
  websiteUrl        String?
  isVerified        Boolean             @default(false)
  isPremium         Boolean             @default(false)
  premiumExpiresAt  DateTime?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  submissions       Submission[]
  problems          Problem[]           @relation("CreatedProblems")
  contests          ContestParticipant[]
  discussions       Discussion[]
  comments          Comment[]
  reactions         Reaction[]
  votes             Vote[]
  
  @@index([username])
  @@index([email])
  @@index([rating])
}

model Problem {
  id                String              @id @default(cuid())
  title             String
  slug              String              @unique
  description       String
  difficulty        String              // enum Difficulty
  rating            Int                 @default(1200)
  tags              String              // SQLite doesn't support String[], store as CSV
  sampleInput       String
  sampleOutput      String
  explanation       String?
  constraints       String?
  timeLimit         Int                 @default(2000) // milliseconds
  memoryLimit       Int                 @default(256)  // MB
  isFree            Boolean             @default(true)
  isPremium         Boolean             @default(false)
  acceptedCount     Int                 @default(0)
  submissionCount   Int                 @default(0)
  createdById       String
  createdBy         User                @relation("CreatedProblems", fields: [createdById], references: [id])
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  testCases         TestCase[]
  submissions       Submission[]
  contests          ContestProblem[]
  discussions       Discussion[]
  
  @@index([difficulty])
  @@index([rating])
  @@index([createdById])
}

model TestCase {
  id                String              @id @default(cuid())
  problemId         String
  problem           Problem             @relation(fields: [problemId], references: [id], onDelete: Cascade)
  input             String
  expectedOutput    String
  isHidden          Boolean             @default(false)
  isSample          Boolean             @default(false)
  points            Int                 @default(10)
  createdAt         DateTime            @default(now())
  
  @@index([problemId])
}

model Submission {
  id                String              @id @default(cuid())
  userId            String
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  problemId         String
  problem           Problem             @relation(fields: [problemId], references: [id], onDelete: Cascade)
  contestId         String?
  contest           Contest?            @relation(fields: [contestId], references: [id], onDelete: SetNull)
  code              String
  language          String              // enum Language
  verdict           String              @default("PENDING") // enum Verdict
  executionTime     Int?                // milliseconds
  memoryUsed        Int?                // KB
  score             Int                 @default(0)
  testCasesPassed   Int                 @default(0)
  totalTestCases    Int                 @default(0)
  errorMessage      String?
  testResults       String?             // SQLite doesn't support JSON, store as stringified JSON
  createdAt         DateTime            @default(now())
  
  @@index([userId, createdAt])
  @@index([problemId])
  @@index([contestId])
  @@index([verdict])
}

model Contest {
  id                String              @id @default(cuid())
  title             String
  slug              String              @unique
  description       String?
  startTime         DateTime
  endTime           DateTime
  duration          Int                 // minutes
  isPublic          Boolean             @default(true)
  isPremium         Boolean             @default(false)
  ratingChange      Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  problems          ContestProblem[]
  participants      ContestParticipant[]
  submissions       Submission[]
  
  @@index([startTime])
  @@index([slug])
}

model ContestProblem {
  id                String              @id @default(cuid())
  contestId         String
  contest           Contest             @relation(fields: [contestId], references: [id], onDelete: Cascade)
  problemId         String
  problem           Problem             @relation(fields: [problemId], references: [id], onDelete: Cascade)
  order             Int
  points            Int                 @default(100)
  
  @@unique([contestId, problemId])
  @@index([contestId])
}

model ContestParticipant {
  id                String              @id @default(cuid())
  contestId         String
  contest           Contest             @relation(fields: [contestId], references: [id], onDelete: Cascade)
  userId            String
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  score             Int                 @default(0)
  penalty           Int                 @default(0)
  rank              Int?
  ratingChange      Int                 @default(0)
  problemsSolved    Int                 @default(0)
  registeredAt      DateTime            @default(now())
  
  @@unique([contestId, userId])
  @@index([contestId, score])
}

model Discussion {
  id                String              @id @default(cuid())
  title             String
  content           String
  userId            String
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  problemId         String?
  problem           Problem?            @relation(fields: [problemId], references: [id], onDelete: Cascade)
  tags              String              // CSV: "dynamic-programming,graphs"
  upvotes           Int                 @default(0)
  downvotes         Int                 @default(0)
  viewCount         Int                 @default(0)
  isPinned          Boolean             @default(false)
  isClosed          Boolean             @default(false)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  comments          Comment[]
  reactions         Reaction[]
  votes             Vote[]
  
  @@index([userId])
  @@index([problemId])
  @@index([createdAt])
}


model Comment {
  id                String              @id @default(cuid())
  content           String
  userId            String
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  discussionId      String
  discussion        Discussion          @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  parentId          String?
  parent            Comment?            @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies           Comment[]           @relation("CommentReplies")
  upvotes           Int                 @default(0)
  downvotes         Int                 @default(0)
  isAccepted        Boolean             @default(false)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  reactions         Reaction[]
  votes             Vote[]
  
  @@index([userId])
  @@index([discussionId])
  @@index([parentId])
}


model Vote {
  id                String              @id @default(cuid())
  type              String              // "UP" or "DOWN"
  userId            String
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  discussionId      String?
  discussion        Discussion?         @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  commentId         String?
  comment           Comment?            @relation(fields: [commentId], references: [id], onDelete: Cascade)
  createdAt         DateTime            @default(now())
  
  @@unique([userId, discussionId])
  @@unique([userId, commentId])
  @@index([discussionId])
  @@index([commentId])
}

model Reaction {
  id                String              @id @default(cuid())
  emoji             String              // Single emoji: "üëç", "‚ù§Ô∏è", "üî•"
  userId            String
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  discussionId      String?
  discussion        Discussion?         @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  commentId         String?
  comment           Comment?            @relation(fields: [commentId], references: [id], onDelete: Cascade)
  createdAt         DateTime            @default(now())
  
  @@unique([emoji, userId, discussionId])
  @@unique([emoji, userId, commentId])
  @@index([discussionId])
  @@index([commentId])
}

model Payment {
  id                String              @id @default(cuid())
  userId            String
  amount            Float
  currency          String              @default("USD")
  planType          String              // enum PlanType
  transactionId     String              @unique
  paymentMethod     String
  status            String
  createdAt         DateTime            @default(now())
  
  @@index([userId])
  @@index([transactionId])
}
